import { LineEdit, ScrollView, VerticalBox, HorizontalBox, StandardButton, Button, ComboBox } from "std-widgets.slint";

export struct FileItem {
    id: int,
    name: string,
    path: string,
    size: int,
    modified_time: string,
    file_type: string,
}

export component AppWindow inherits Window {
    title: "File Search Tool";
    preferred-width: 800px;
    preferred-height: 600px;
    
    in-out property <[FileItem]> file-items: [];
    in-out property <string> search-text: "";
    in-out property <[string]> available-databases: [];
    in-out property <int> current-database-index: 0;
    in-out property <bool> context-menu-visible: false;
    in-out property <FileItem> selected-file-item: { id: 0, name: "", path: "", size: 0, modified_time: "", file_type: "" };
    in-out property <length> context-menu-x: 0px;
    in-out property <length> context-menu-y: 0px;
    
    callback search-requested(string);
    callback database-changed(int);
    callback file-context-menu-requested(FileItem, length, length);
    callback open-file(string);
    callback open-file-location(string);
    
    // ä¸»å†…å®¹åŒºåŸŸ
    Rectangle {
        width: 100%;
        height: 100%;
        
        VerticalBox {
        padding: 20px;
        spacing: 15px;
        
        // æ•°æ®åº“é€‰æ‹©å™¨ - ä½¿ç”¨ä¸‹æ‹‰åˆ—è¡¨
        HorizontalBox {
            spacing: 10px;
            alignment: start;
            
            Text {
                text: "Database:";
                vertical-alignment: center;
                font-weight: 600;
                width: 80px;
            }
            
            // æ•°æ®åº“ä¸‹æ‹‰é€‰æ‹©æ¡†
            database-combo := ComboBox {
                width: 250px;
                model: root.available-databases;
                current-index: root.current-database-index;
            }
            
            // åˆ·æ–°æ•°æ®åº“åˆ—è¡¨æŒ‰é’®
            Button {
                text: "ðŸ”„";
                clicked => {
                    // è§¦å‘æ•°æ®åº“åˆ—è¡¨åˆ·æ–°
                    root.database-changed(-1); // -1 è¡¨ç¤ºåˆ·æ–°åˆ—è¡¨
                }
            }
        }
        
        // æœç´¢æ¡†
        HorizontalBox {
            spacing: 10px;
            alignment: start;
            
            Text {
                text: "Search:";
                vertical-alignment: center;
                font-weight: 600;
                width: 80px;
            }
            
            search-input := LineEdit {
                width: 400px;
                placeholder-text: "Enter file name or path...";
                edited => {
                    root.search-text = self.text;
                    root.search-requested(root.search-text);
                }
                accepted => {
                    root.search-requested(root.search-text);
                }
            }
            
            Rectangle {
                width: 80px;
                height: 30px;
                background: #007acc;
                border-radius: 5px;
                
                TouchArea {
                    clicked => {
                        root.search-requested(root.search-text);
                    }
                }
                
                Text {
                    text: "Search";
                    color: white;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-weight: 600;
                }
            }
        }
        
        // æœç´¢ç»“æžœåˆ—è¡¨
        ScrollView {
            preferred-height: 100%;
            
            VerticalBox {
                spacing: 5px;
                
                if root.file-items.length == 0 : Text {
                    text: "No matching files found";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    opacity: 0.5;
                    height: 100px;
                }
                
                for file-item in root.file-items : Rectangle {
                    height: 60px;
                    background: #ffffff;
                    border-radius: 5px;
                    border-width: 1px;
                    border-color: #e0e0e0;
                    
                    TouchArea {
                        clicked => {
                            root.selected-file-item = file-item;
                            root.context-menu-visible = false;
                        }
                        
                        // æ·»åŠ ä¸€ä¸ªéšè—çš„å³é”®æ£€æµ‹åŒºåŸŸ
                        TouchArea {
                            // å°è¯•æ£€æµ‹å³é”®äº‹ä»¶
                            clicked => {
                                // æ™®é€šå·¦é”®ç‚¹å‡»ï¼Œå…³é—­èœå•
                                root.selected-file-item = file-item;
                                root.context-menu-visible = false;
                            }
                            
                            // ç”±äºŽSlint 1.3çš„é™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ–¹æ³•
                            // åœ¨æ–‡ä»¶é¡¹ä¸Šæ˜¾ç¤ºä¸€ä¸ªå°çš„èœå•æŒ‰é’®
                        }
                        
                        // æ·»åŠ èœå•æŒ‰é’®ï¼ˆç”¨äºŽæµ‹è¯•å³é”®åŠŸèƒ½ï¼‰
                        Button {
                            x: parent.width - 30px;
                            y: 15px;
                            width: 20px;
                            height: 20px;
                            text: "â‹®";
                            padding: 0px;
                            
                            clicked => {
                                root.selected-file-item = file-item;
                                root.context-menu-x = self.absolute-position.x;
                                root.context-menu-y = self.absolute-position.y + 20px;
                                root.context-menu-visible = true;
                                root.file-context-menu-requested(file-item, self.absolute-position.x, self.absolute-position.y + 20px);
                            }
                        }
                        
                        HorizontalBox {
                            padding: 10px;
                            spacing: 10px;
                            
                            Rectangle {
                                width: 40px;
                                height: 40px;
                                background: #007acc;
                                border-radius: 5px;
                                
                                Text {
                                    text: "ðŸ“„";
                                    font-size: 20px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                    color: white;
                                }
                            }
                            
                            VerticalBox {
                                spacing: 5px;
                                
                                Text {
                                    text: file-item.name;
                                    font-size: 14px;
                                    font-weight: 600;
                                }
                                
                                Text {
                                    text: file-item.path;
                                    font-size: 12px;
                                    color: #666666;
                                    overflow: elide;
                                }
                                
                                HorizontalBox {
                                    spacing: 10px;
                                    
                                    Text {
                                        text: "Size: " + (file-item.size / 1024) + " KB";
                                        font-size: 11px;
                                        color: #888888;
                                    }
                                    
                                    Text {
                                        text: "Modified: " + file-item.modified_time;
                                        font-size: 11px;
                                        color: #888888;
                                    }
                                }
                            }
                            }
                            
                            // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­èœå•
                            TouchArea {
                                clicked => {
                                    root.context-menu-visible = false;
                                }
                            }
                        }
                        
                        // å³é”®ä¸Šä¸‹æ–‡èœå• - ç»å¯¹å®šä½åœ¨ä¸»çª—å£ä¸Š
                        if root.context-menu-visible : Rectangle {
                            x: root.context-menu-x;
                            y: root.context-menu-y;
                            width: 150px;
                            height: 80px;
                            background: #ffffff;
                            border-radius: 5px;
                            border-width: 1px;
                            border-color: #cccccc;
                            drop-shadow-blur: 5px;
                            drop-shadow-offset-x: 2px;
                            drop-shadow-offset-y: 2px;
                            
                            VerticalLayout {
                                padding: 5px;
                                spacing: 2px;
                                
                                Button {
                                    text: "æ‰“å¼€æ–‡ä»¶";
                                    clicked => {
                                        root.open-file(root.selected-file-item.path);
                                        root.context-menu-visible = false;
                                    }
                                }
                                
                                Button {
                                    text: "æ‰“å¼€æ–‡ä»¶ä½ç½®";
                                    clicked => {
                                        root.open-file-location(root.selected-file-item.path);
                                        root.context-menu-visible = false;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
