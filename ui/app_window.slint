import {
    LineEdit,
    ScrollView,
    VerticalBox,
    HorizontalBox,
    StandardButton,
    Button,
    ComboBox,
} from "std-widgets.slint";

export struct FileItem {
    id: int,
    name: string,
    path: string,
    size: int,
    modified_time: string,
    file_type: string,
}

export component AppWindow inherits Window {
    title: "File Search Tool";
    preferred-width: 800px;
    preferred-height: 600px;
    in-out property <[FileItem]> file-items: [];
    in-out property <string> search-text: "";
    in-out property <[string]> available-databases: [];
    in-out property <int> current-database-index: 0;
    in-out property <bool> context-menu-visible: false;
    in-out property <FileItem> selected-file-item: { id: 0, name: "", path: "", size: 0, modified_time: "", file_type: "" };
    in-out property <length> context-menu-x: 0px;
    in-out property <length> context-menu-y: 0px;
    callback search-requested(string);
    callback database-changed(int);
    callback file-context-menu-requested(FileItem, length, length);
    callback open-file(string);
    callback open-file-location(string);
    callback send-to-aria2(string);
    
    // ä¸»å†…å®¹åŒºåŸŸ
    Rectangle {
        width: 100%;
        height: 100%;
        VerticalBox {
            padding: 20px;
            spacing: 15px;
        
        // æ•°æ®åº“é€‰æ‹©å™¨ - ä½¿ç”¨ä¸‹æ‹‰åˆ—è¡¨
        HorizontalBox {
                spacing: 10px;
                alignment: start;
                Text {
                    text: "Database:";
                    vertical-alignment: center;
                    font-weight: 600;
                    width: 80px;
                }
            
            // æ•°æ®åº“ä¸‹æ‹‰é€‰æ‹©æ¡†
            database-combo := ComboBox {
                    width: 300px;
                    model: root.available-databases;
                    current-index: root.current-database-index;
                }
            
            // åˆ·æ–°æ•°æ®åº“åˆ—è¡¨æŒ‰é’®
            Button {
                    text: "ðŸ”„";
                    clicked => {
                    // è§¦å‘æ•°æ®åº“åˆ—è¡¨åˆ·æ–°
                    root.database-changed(-1); // -1 è¡¨ç¤ºåˆ·æ–°åˆ—è¡¨
                }
                }
            }
        
        // æœç´¢æ¡†
        HorizontalBox {
                spacing: 10px;
                alignment: start;
                Text {
                    text: "Search:";
                    vertical-alignment: center;
                    font-weight: 600;
                    width: 80px;
                }

                search-input := LineEdit {
                    // width: root.width / 2;
                    max-width: self.min-width;
                    placeholder-text: "Enter file name or path...";
                    edited => {
                        root.search-text = self.text;
                        root.search-requested(root.search-text);
                    }
                    accepted => {
                        root.search-requested(root.search-text);
                    }
                }

                Rectangle {
                    width: 80px;
                    height: 30px;
                    background: #007acc;
                    border-radius: 5px;

                    Text {
                        text: "Search";
                        color: white;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        font-weight: 600;
                    }
                }
                TouchArea {
                    opacity: 0.8;
                    clicked => {
                        root.search-requested(root.search-text);
                    }
                }
            }
        
        // æœç´¢ç»“æžœåˆ—è¡¨
        ScrollView {
                preferred-height: 100%;
                VerticalBox {
                    spacing: 5px;
                    if root.file-items.length == 0: Text {
                        text: "No matching files found";
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        opacity: 0.5;
                        height: 100px;
                    }
                    for file-item in root.file-items: Rectangle {
                        height: 60px;
                        background: #ffffff;
                        border-radius: 5px;
                        border-width: 1px;
                        border-color: #e0e0e0;
                        TouchArea {
                            // è¦†ç›–æ•´ä¸ª item åŒºåŸŸï¼Œå¤„ç†å·¦é”®é€‰æ‹©å’Œå³é”®å¼¹å‡ºèœå•
                            width: parent.width;
                            height: parent.height;
                            clicked => {
                                root.selected-file-item = file-item;
                                root.context-menu-visible = false;
                            }
                            pointer-event(event) => {
                                if event.kind == PointerEventKind.down && event.button == PointerEventButton.right {
                                    // å³é”®æ‰“å¼€ä¸Šä¸‹æ–‡èœå•ï¼ˆä½¿ç”¨ item çš„ç»å¯¹ä½ç½®ï¼‰
                                    root.selected-file-item = file-item;
                                    root.context-menu-x = self.absolute-position.x;
                                    root.context-menu-y = self.absolute-position.y + 10px;
                                    if root.context-menu-visible == false {
                                        root.context-menu-visible = true;
                                    }
                                    root.file-context-menu-requested(file-item, self.absolute-position.x, self.absolute-position.y + 20px);
                                }
                            }
                            HorizontalBox {
                                padding: 10px;
                                spacing: 10px;
                                Rectangle {
                                    width: 40px;
                                    height: 40px;
                                    background: #007acc;
                                    border-radius: 5px;
                                    Text {
                                        text: "ðŸ“„";
                                        font-size: 20px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                        color: white;
                                    }
                                }

                                VerticalBox {
                                    spacing: 5px;
                                    Text {
                                        text: file-item.name;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: file-item.path;
                                        font-size: 12px;
                                        color: #666666;
                                        overflow: elide;
                                    }

                                    HorizontalBox {
                                        spacing: 10px;
                                        Text {
                                            text: "Size: " + (file-item.size / 1024) + " KB";
                                            font-size: 11px;
                                            color: #888888;
                                        }

                                        Text {
                                            text: "Modified: " + file-item.modified_time;
                                            font-size: 11px;
                                            color: #888888;
                                        }
                                    }
                                }
                            }
                            // ï¼ˆå³é”®/å…³é—­çš„é€»è¾‘å·²åˆå¹¶åˆ°ä¸Šæ–¹ TouchAreaï¼‰
                        }
                        
                        // å³é”®ä¸Šä¸‹æ–‡èœå• - ç»å¯¹å®šä½åœ¨ä¸»çª—å£ä¸Š
                        if root.context-menu-visible: Rectangle {
                            x: root.context-menu-x;
                            y: root.context-menu-y;
                            width: 150px;
                            height: 120px;
                            background: #ffffff;
                            border-radius: 5px;
                            border-width: 1px;
                            border-color: #cccccc;
                            drop-shadow-blur: 5px;
                            drop-shadow-offset-x: 2px;
                            drop-shadow-offset-y: 2px;
                            VerticalLayout {
                                padding: 5px;
                                spacing: 2px;
                                Button {
                                    text: "æ‰“å¼€æ–‡ä»¶";
                                    clicked => {
                                        root.open-file(root.selected-file-item.path);
                                        root.context-menu-visible = false;
                                    }
                                }

                                Button {
                                    text: "æ‰“å¼€æ–‡ä»¶ä½ç½®";
                                    clicked => {
                                        root.open-file-location(root.selected-file-item.path);
                                        root.context-menu-visible = false;
                                    }
                                }

                                Button {
                                    text: "Send To aria2";
                                    clicked => {
                                        root.send-to-aria2(root.selected-file-item.path);
                                        root.context-menu-visible = false;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
